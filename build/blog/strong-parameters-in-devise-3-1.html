<!doctype html>
<html>
  <head>
    <meta content='IE=edge' http-equiv='X-UA-Compatible'>
    <meta charset='utf-8'>
    <meta content='width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no' name='viewport'>
    <meta name='description' content="In Devise 3.1+ there&#39;s a new way to handle Rails 4&#39;s strong parameters. Here&#39;s a quick rundown of the change, and how to migrate to the new style. (Background: I wrote the pull request that helped form this feature).">
    

    <title>Handling strong parameters in Devise 3.1+ - Alex Peattie</title>

    <link href='//fonts.googleapis.com/css?family=Lato:300,400' rel='stylesheet' type='text/css'>

    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#ff0000">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ff0000">

    <link href="/assets/css/all.css" rel="stylesheet" />
    <script src="/assets/js/all.js"></script>
  </head>

  <body class='blog blog_strong-parameters-in-devise-3-1'>
    <header>
  <nav class='MainMenu'>
    <a href='/' class='Logo'>
      <span>alex</span>peattie
    </a>

    <a class='NavBtn NavBtn--mobileOnly' data-toggle-modal-menu>Menu</a>

    <section class='MainMenu-links'>
      <a href='/' class='NavBtn' id='NavBtnAbout'>About Me</a>
    <!--  <a href='/projects' class='NavBtn' id='NavBtnProjects'>Projects</a> -->
    <!-- <a href='/talks' class='NavBtn' id='NavBtnTalks'>Talks</a> -->
    <!-- <a href='/blog' class='NavBtn' id='NavBtnBlog'>Blog</a> -->

      <a class='NavBtn NavBtn--close' data-toggle-modal-menu>✕</a>
    </nav>
  </nav>

  
</header>


    <main>
        <article class='ContentBody'>
    <h1>Handling strong parameters in Devise 3.1+</h1>
    <h2 class='PostMeta'>
      <time datetime="2014-02-16" pubdate="true">16th February 2014</time> – 
      <a href='#comments' data-disqus-url='http://alexpeattie.com/blog/strong-parameters-in-devise-3-1.html'>comments</a>
    </h2>
    <p>In Devise 3.1+ there's a new way to handle Rails 4's strong parameters. Here's a quick rundown of the change, and how to migrate to the new style. (Background: I wrote <a href="https://github.com/plataformatec/devise/pull/2566">the pull request</a> that helped form this feature).</p>

<p><em>TLDR; You can now shovel params (as symbols) into <code>devise_parameter_sanitizer.for</code></em></p>

<h2 id="the-old-way">The old way</h2>

<p>First a bit of background. Rails 4 introduced the concept of <a href="http://edgeapi.rubyonrails.org/classes/ActionController/StrongParameters.html">strong parameters</a>, to mitigate <a href="http://pragtob.wordpress.com/2012/03/06/secure-your-rails-apps/">mass assignment vulnerabilities</a>. With strong parameters, we whitelist the model attributes that should be writeable in <em>the controller</em>.</p>

<div class="codehilite ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="c1"># app/controllers/articles_controller.rb</span>

<span class="k">def</span> <span class="nf">create</span>
  <span class="c1"># only title and body are whitelisted</span>
  <span class="no">Article</span><span class="p">.</span><span class="nf">create</span> <span class="n">params</span><span class="p">[</span><span class="ss">:article</span><span class="p">].</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:body</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>This is problematic in Devise, because by default we don't see the controllers &amp; actions that Devise uses to handle creating and updating our <code>User</code> model.</p>

<p>Instead Devise gives us an interface to modify the whitelisted parameters that is uses internally: <code>devise_parameter_sanitizer</code>.</p>

<p>Devise has three 'parameter sanitizers': for signing up, signing in and updating your account. Previous to 3.1 <code>devise_parameter_sanitizer</code>  took an argument specifying which sanitizer needs to be modified – either <code>:sign_in</code>, <code>:sign_up</code> or <code>:sign_out</code> – and a block which passes in the un-whitelisted parameters. We can then call <code>.permit</code> on those parameters as normal:</p>

<div class="codehilite ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre><span class="c1"># app/controllers/application_controller.rb</span>

<span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_filter</span> <span class="ss">:configure_permitted_parameters</span><span class="p">,</span> <span class="ss">if: :devise_controller?</span>

  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">configure_permitted_parameters</span>
    <span class="n">devise_parameter_sanitizer</span><span class="p">.</span><span class="nf">for</span><span class="p">(</span><span class="ss">:sign_in</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">u</span><span class="o">|</span> <span class="n">u</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:username</span><span class="p">,</span> <span class="ss">:password</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<h4 id="the-problem">The problem</h4>

<p>The main problem with this approach, is that by providing a block, we overrwrote Devise's default whitelistings. For example, if we wanted to add a <code>username</code> attribute to the permitted parameters, but keep all the Devise defaults, we'd need code like this:</p>

<div class="codehilite ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">configure_permitted_parameters</span>
  <span class="n">devise_parameter_sanitizer</span><span class="p">.</span><span class="nf">for</span><span class="p">(</span><span class="ss">:sign_in</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">u</span><span class="o">|</span> <span class="n">u</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:username</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:remember_me</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">devise_parameter_sanitizer</span><span class="p">.</span><span class="nf">for</span><span class="p">(</span><span class="ss">:sign_up</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">u</span><span class="o">|</span> <span class="n">u</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:username</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">devise_parameter_sanitizer</span><span class="p">.</span><span class="nf">for</span><span class="p">(</span><span class="ss">:account_update</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">u</span><span class="o">|</span> <span class="n">u</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">:current_password</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>..which is pretty verbose for adding a single attribute. Most of this is boilerplate code, to ensure that Devise's default whitelist is still applied.</p>

<h2 id="the-new-way">The new way</h2>

<p>From Devise 3.1+ we can call <code>devise_parameter_sanitizer.for</code> without a block which will return an array of permitted parameters. We can shovel attributes into this array to whitelist them. So the code above would look like this after 3.1:</p>

<div class="codehilite ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">configure_permitted_parameters</span>
  <span class="n">devise_parameter_sanitizer</span><span class="p">.</span><span class="nf">for</span><span class="p">(</span><span class="ss">:sign_in</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="ss">:username</span>
  <span class="n">devise_parameter_sanitizer</span><span class="p">.</span><span class="nf">for</span><span class="p">(</span><span class="ss">:sign_up</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="ss">:username</span>
  <span class="n">devise_parameter_sanitizer</span><span class="p">.</span><span class="nf">for</span><span class="p">(</span><span class="ss">:account_update</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="ss">:username</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>or a DRYer version:</p>

<div class="codehilite ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="p">[</span><span class="ss">:sign_in</span><span class="p">,</span> <span class="ss">:sign_up</span><span class="p">,</span> <span class="ss">:account_update</span><span class="p">].</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">action</span><span class="o">|</span>
  <span class="n">devise_parameter_sanitizer</span><span class="p">.</span><span class="nf">for</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="ss">:username</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<p>You can still pass a block to completely override the Devise defaults if you want.</p>

<h4 id="backwards-incompatability">Backwards incompatability</h4>

<p>The upgrade introduces a small backwards incompatability, although it's fairly unlikely it'll affect your app. Previous to 3.1, if you wanted to explicitly apply a sanitizer and return the filtered parameters, you could call <code>devise_parameter_sanitizer.for</code> without a block. Now sanitizers must be explicitly applied by calling <code>devise_parameter_sanitizer.sanitize</code>.</p>

<p><em>If you anywhere in your pre-3.1 app you're calling <code>devise_parameter_sanitizer.for</code> <strong>without</strong> a block, you'll need to use <code>devise_parameter_sanitizer.sanitize</code> instead.</em></p>

  </article>
  
  <article class='Comments'>
  <h2 id='comments'>Comments</h2>

  <div id='disqus_thread'>
  </div>

  <script>
    var disqus_shortname = 'alexpeattie';
    var disqus_url = 'http://alexpeattie.com/blog/strong-parameters-in-devise-3-1.html';
    var disqus_identifier = '2014 02 16 strong parameters in devise 3 1';

    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
      var s = document.createElement('script'); s.async = true; s.type = 'text/javascript';
      s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq).appendChild(s);
    })();
  </script>
</article>

    </main>

    <section class='SourceCallout'>
    <!--  <p>This site is open-source (<a href='/projects#site'>more info</a>) - here's <a href="https://github.com/alexpeattie/alexpeattie.com/blob/master/source/blog/2014-02-16-strong-parameters-in-devise-3-1.html.md">the source code for this page</a></a>.</p>-->
    </section>

    <footer>
      <p>© 2018 Emil Karlsson. Questions? Email <a href='mailto:me@emilingemarkarlsson@gmail.com'>emilingemarkarlsson@gmail.com</a>
      </p>
    </footer>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21840499-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
