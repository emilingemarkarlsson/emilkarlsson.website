<!doctype html>
<html>
  <head>
    <meta content='IE=edge' http-equiv='X-UA-Compatible'>
    <meta charset='utf-8'>
    <meta content='width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no' name='viewport'>
    <meta name='description' content="In a recent project, I had to send data between two subdomains on a site. Unfortunately, this meant I had to deal with browsers&#39; same origin policy. The canonical solution to this is to set up Cross-origin resource sharing (CORS) , but this is a bit of a pain to do1 - especially if you&#39;re only making one or two cross-domain requests - and it isn&#39;t supported by some older browsers. Luckily there are some alternatives.">
    

    <title>Cross-domain communication without CORS - Alex Peattie</title>

    <link href='//fonts.googleapis.com/css?family=Lato:300,400' rel='stylesheet' type='text/css'>

    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#ff0000">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ff0000">

    <link href="/assets/css/all.css" rel="stylesheet" />
    <script src="/assets/js/all.js"></script>
  </head>

  <body class='blog blog_cross-domain-communication-without-cors'>
    <header>
  <nav class='MainMenu'>
    <a href='/' class='Logo'>
      <span>emil</span>karlsson
    </a>

    <a class='NavBtn NavBtn--mobileOnly' data-toggle-modal-menu>Menu</a>

    <section class='MainMenu-links'>
      <a href='/' class='NavBtn' id='NavBtnAbout'>About Me</a>
      <a href='/projects' class='NavBtn' id='NavBtnProjects'>Projects</a>
    <!-- <a href='/talks' class='NavBtn' id='NavBtnTalks'>Talks</a> -->
    <!-- <a href='/blog' class='NavBtn' id='NavBtnBlog'>Blog</a> -->

      <a class='NavBtn NavBtn--close' data-toggle-modal-menu>✕</a>
    </nav>
  </nav>

  
</header>


    <main>
        <article class='ContentBody'>
    <h1>Cross-domain communication without CORS</h1>
    <h2 class='PostMeta'>
      <time datetime="2013-02-01" pubdate="true">1st February 2013</time> – 
      <a href='#comments' data-disqus-url='http://alexpeattie.com/blog/cross-domain-communication-without-cors.html'>comments</a>
    </h2>
    <p>In a recent project, I had to send data between two subdomains on a site. Unfortunately, this meant I had to deal with <a href="http://en.wikipedia.org/wiki/Same_origin_policy">browsers' same origin policy</a>. The canonical solution to this is to set up Cross-origin resource sharing (<a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a>) , but this is a bit of a pain to do<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup> - especially if you're only making one or two cross-domain requests - and it isn't supported by some older browsers. Luckily there are some alternatives.</p>

<h2 id="jsonp">JSONP</h2>

<p><a href="http://en.wikipedia.org/wiki/JSONP">JSONP</a> (JSON with padding) basically just means wrapping JSON in a function. So instead of this:</p>

<div class="codehilite javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">{</span> <span class="nl">foo</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">bar</span><span class="err">:</span> <span class="mi">5</span> <span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<p>You have this:</p>

<div class="codehilite javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="nx">callbackFunction</span><span class="p">({</span> <span class="na">foo</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="na">bar</span><span class="p">:</span> <span class="mi">5</span> <span class="p">})</span>
</pre></td></tr></tbody></table>
</div>

<p>Now all you have to do is define <code>callbackFunction()</code> and then load in your JSONP with a <code>&lt;script&gt;</code> tag:</p>

<div class="codehilite html"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://otherdomain.com/jsonp.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="kd">function</span> <span class="nx">callbackFunction</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">foo</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">bar</span><span class="p">);</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</pre></td></tr></tbody></table>
</div>

<p>This is really easy to set up in Rails, you can just <code>render :json</code> as normal, but add a <code>:callback</code> option to turn it into JSONP:</p>

<div class="codehilite ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">example</span>
  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
    <span class="nb">format</span><span class="p">.</span><span class="nf">js</span> <span class="k">do</span> 
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">foo: </span><span class="mi">3</span><span class="p">,</span> <span class="ss">bar: </span><span class="mi">5</span> <span class="p">},</span> <span class="ss">callback: </span><span class="s2">"callbackFunction"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<h2 id="documentdomain">document.domain</h2>

<p>This solution is even simpler, but <em>only</em> works if you're dealing with different subdomains (not different domains). You can tell pages from <code>http://a.example.com</code> and <code>http://b.example.com</code> to trust each other by setting their <code>document.domain</code> property (<a href="https://developer.mozilla.org/en-US/docs/DOM/document.domain">MDN</a>) to point to the root domain:</p>

<div class="codehilite javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="c1">// On both a.example.com and b.example.com</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">domain</span> <span class="o">=</span> <span class="s2">"example.com"</span>
</pre></td></tr></tbody></table>
</div>

<p>However, if we tried to change <code>document.domain</code> to <code>somewhereelse.com</code>, we'd get an <code>Illegal document.domain value</code> error.</p>

<h2 id="windowpostmessage">window.postMessage</h2>

<p>If you have an iframe pulling content from a different domain, and you need the iframe and parent window to communicate, your best bet is <code>window.postMessage</code> (<a href="https://developer.mozilla.org/en-US/docs/DOM/window.postMessage">MDN</a>). It's not compatible across all browsers, but its <a href="http://caniuse.com/x-doc-messaging">quite widely supported</a>.</p>

<p>For example your iframe could send a message to the parent window like so:</p>

<div class="codehilite javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>

<p>Which is handled by the parent window's <code>message</code> event handler:</p>

<div class="codehilite javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">"message"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span> <span class="o">==</span> <span class="s2">"hello "</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"The iframe said hello!"</span><span class="p">);</span>
<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
</pre></td></tr></tbody></table>
</div>

<p>You'd also probably want to validate the origin the message is being sent from, by checking <code>e.origin</code>.</p>

<h2 id="footnotes">Footnotes</h2>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>Alexey Vasiliev has <a href="http://leopard.in.ua/2012/07/08/using-cors-with-rails/">a good tutorial</a> for setting up CORS on Rails. Additionally, this Rack middleware may be of help: <a href="https://github.com/cyu/rack-cors">https://github.com/cyu/rack-cors</a>. <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

  </article>
  
  <article class='Comments'>
  <h2 id='comments'>Comments</h2>

  <div id='disqus_thread'>
  </div>

  <script>
    var disqus_shortname = 'alexpeattie';
    var disqus_url = 'http://alexpeattie.com/blog/cross-domain-communication-without-cors.html';
    var disqus_identifier = '2013 02 01 cross domain communication without cors';

    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
      var s = document.createElement('script'); s.async = true; s.type = 'text/javascript';
      s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq).appendChild(s);
    })();
  </script>
</article>

    </main>

    <section class='SourceCallout'>
    <!--  <p>This site is open-source (<a href='/projects#site'>more info</a>) - here's <a href="https://github.com/alexpeattie/alexpeattie.com/blob/master/source/blog/2013-02-01-cross-domain-communication-without-cors.html.md">the source code for this page</a></a>.</p>-->
    </section>

    <footer>
      <p>© 2018 Emil Karlsson. Questions? Email <a href='mailto:me@emilingemarkarlsson@gmail.com'>emilingemarkarlsson@gmail.com</a>
      </p>
    </footer>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21840499-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
